version: '3.8'

services:
  waz-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: waz-nieplitz-test
    environment:
      - USERNAME=${TEST_USERNAME:-your_username}
      - PASSWORD=${TEST_PASSWORD:-your_password}
      - UPDATE_INTERVAL=86400
      - MAIN_METER_NAME=Test Water Meter Main
      - GARDEN_METER_NAME=Test Water Meter Garden
      # Mock supervisor token for testing
      - SUPERVISOR_TOKEN=test_token_12345
    volumes:
      # Mount test data directory
      - ./test_data:/data
      # Mount the script for live editing during tests
      - ./run.py:/run.py:ro
    networks:
      - test-network
    # Override the default command to keep container running for testing
    command: tail -f /dev/null
    # Uncomment to actually run the add-on in test mode:
    # command: python3 -u /run.py

  # Optional: Mock Home Assistant API server for testing
  # mock-ha-api:
  #   image: python:3.11-alpine
  #   container_name: mock-ha-api
  #   volumes:
  #     - ./test_mock_api.py:/app/mock_api.py
  #   working_dir: /app
  #   command: python3 mock_api.py
  #   networks:
  #     - test-network
  #   ports:
  #     - "8123:8123"

networks:
  test-network:
    driver: bridge

volumes:
  test_data:
